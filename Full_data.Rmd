---
title: "Full data"
author: "Jaehee and David"
date: "4/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(devtools)
library(blsAPI) 
library(rjson)
library(eia) 
library(lubridate)
library(diffdf)
library(ggplot2)
library(dplyr)
```

```{r}
# Creates a dataframe with the state name, abbreviation, and "state code"
state_code <-c(1:2,4:6, 8:13, 15:42, 44:51,54:56)
states <-tibble(state_name = state.name, state_abrv = state.abb, state_code = state_code)
states %>%
  mutate(state_code = case_when(
    state_code<10 ~ str_c("0",as.character(state_code)),
    state_code>=10 ~ str_c(as.character(state_code))
  ))->states
```

``` {r}
############## not sure if we need the line below
# eia_set_key("8a87a727635f5c834e2799cd76fcb820")

# Create a tibble for each variable we want, where the tibble contains the components of the api call for each state, e.g. "ELEC.PRICE." + "AL" + "-IND.A"
avg_elec <- tibble(start = "ELEC.PRICE.", abrv = state.abb, end = "-IND.A") %>% 
  mutate(id = str_c(start, abrv, end)) %>%
  select(id) %>% 
  as.list() %>% 
  # magrittr:extract2(x, 1) is equivalent to x[[1]]
  magrittr::extract2(1) %>% 
  eia_series() %>% 
  select(data) %>% 
  mutate(state = states$state_name) %>% 
  select(state, everything()) %>% 
  unnest(data) %>% 
  rename("electricity_price" = value) %>% 
  filter(year>=2008 & year <= 2017)

emission <-tibble(start = "EMISS.CO2-TOTV-EC-TO-", abrv = state.abb, end = ".A") %>% 
  mutate(id = str_c(start, abrv, end))%>%
  select(id) %>% 
  as.list() %>% 
  magrittr::extract2(1) %>% 
  eia_series()%>% 
  select(data) %>% 
  mutate(state = states$state_name) %>% 
  select(state, everything()) %>% 
  unnest(data) %>% 
  rename("carbon_emissions" = value) %>% 
  filter(year>=2008 & year <= 2017)

customers <- tibble(start = "ELEC.CUSTOMERS.", abrv = state.abb, end = "-ALL.A") %>% 
  mutate(id = str_c(start, abrv, end))%>%
  select(id) %>% 
  as.list() %>% 
  magrittr::extract2(1) %>% 
  eia_series()%>% 
  select(data) %>% 
  mutate(state = states$state_name) %>% 
  select(state, everything()) %>% 
  unnest(data) %>% 
  rename("customers" = value) %>% 
  filter(year>=2008 & year <= 2017)

retail_sales <- tibble(start = "ELEC.SALES.", abrv = state.abb, end = "-ALL.A") %>%  
  mutate(id = str_c(start, abrv, end))%>%
  select(id) %>% 
  as.list() %>% 
  magrittr::extract2(1) %>% 
  eia_series()%>% 
  select(data) %>% 
  mutate(state = states$state_name) %>% 
  select(state, everything()) %>% 
  unnest(data) %>% 
  rename("retail_sales" = value) %>% 
  filter(year>=2008 & year <= 2017)
  

total_electricity <- tibble(start = "ELEC.GEN.ALL-",  abrv = state.abb, end = "-99.A") %>%  
  mutate(id = str_c(start, abrv, end))%>%
  select(id) %>% 
  as.list() %>% 
  magrittr::extract2(1) %>% 
  eia_series()%>% 
  select(data) %>% 
  mutate(state = states$state_name) %>% 
  select(state, everything()) %>% 
  unnest(data) %>% 
  rename("total_electricity" = value) %>% 
  filter(year>=2008 & year <= 2017)
```

```{r}
merge(avg_elec, emmission, by = c("year", "date", "state")) -> full_data_0
merge(full_data_0, customers, by = c("year", "date", "state")) -> full_data_1
merge(full_data_1, retail_sales, by = c("year", "date", "state")) -> full_data_2
merge(full_data_2, total_electricity, by = c("year", "date", "state")) -> final_data

```

# Test
```{r}
ggplot(final_data, aes(x = Electricity_Price, y = Total_electricity))+
                    geom_point()+
                    geom_smooth(method = "lm")
```


