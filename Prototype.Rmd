---
title: "Chris Code"
author: "Christopher Hopkins"
date: "4/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(devtools)
# Install blsAPI Package
library(blsAPI) #BLS API
library(rjson)
# INstall eia Package
library(eia) #Energy API
library(lubridate)
<<<<<<< HEAD
=======
#compares data frames
library(diffdf)
>>>>>>> d847ce27f09e928fbcaba91f8bfbfa15db68b4a6
```

```{r}
#Creating a tibble of state name, state abrv and BLS state code
#This is a list of the state codes for the BLS database
state_code <-c(1:2,4:6, 8:13, 15:42, 44:51,54:56)

#Makes the tibble states
states <-tibble(state_name = state.name, state_abrv = state.abb, state_code = state_code)

states

states %>% 
  mutate(state_code = case_when(
    state_code<10 ~ str_c("0",as.character(state_code)),
    state_code>=10 ~ str_c(as.character(state_code))
  ))->states


#Creating IDs BLS

BLS_id <- tibble (start = c("LAUST", "TEST"), state = list(states$state_code), end = "0000000000003")

unnest(BLS_id)->BLS_id

BLS_id %>% 
  mutate(seriesID = str_c(start, state, end))->BLS_id

BLS_id %>% 
  filter(start == "LAUST")->BLS_id

#Data set name i.e. Unemployment rate, Employment rate, etc.
BLS_id %>% 
  mutate(type = case_when(
    start == "LAUST" ~ "Unemployment Rate"
  ))->BLS_id

BLS_id
#The Next part is for the eia data.

#Creating IDs EIA

<<<<<<< HEAD
eai_id <- tibble(start = "ELEC.PRICE.", abrv = list(state.abb), end = "-IND.M")

unnest(eai_id)->eai_id

eai_id %>% 
  mutate(id = str_c(start, abrv, end))->eai_id

eai_id

=======
eai_avg_elect <- tibble(start = "ELEC.PRICE.", abrv = list(state.abb), end = "-IND.M")

eai_carbon_emission <-tibble( start = "EMISS.CO2-TOTV-EC-TO-", abrv = list(state.abb), end = ".A")

eai_customers <- tibble( start = "ELEC.CUSTOMERS.", abrv = list(state.abb), end = "-ALL.A")

unnest(eai_avg_elect)->eai_avg_elect_id

eai_avg_elect_id %>% 
  mutate(id = str_c(start, abrv, end))->eai_avg_elect_id

eai_avg_elect_id

unnest(eai_carbon_emission)->eai_carbon_emission_id

eai_carbon_emission_id %>% 
 mutate(id = str_c(start, abrv, end))->eai_carbon_emission_id

unnest(eai_customers)->eai_customers

eai_customers %>% 
  mutate(id = str_c(start, abrv, end))->eai_customers_id
>>>>>>> d847ce27f09e928fbcaba91f8bfbfa15db68b4a6
#We can pull lots of data now pretty quickly.

BLS_id$seriesID
#Getting BLS data using generated IDs
<<<<<<< HEAD
data<-list(seriesid = BLS_id$seriesID)
data
blsAPI(data , 2, TRUE)->Unemployment
Unemployment
=======
#BLS API has a limit of 25 returns per querey so you have to run it twice.
data<-list(seriesid = BLS_id$seriesID)
data2<-list(seriesid = BLS_id$seriesID[26:50])
data
data2
blsAPI(data , 2, TRUE)->Unemployment1
blsAPI(data2, 2, TRUE)->Unemployemnt2
Unemployment1
Unemployemnt2

full_join(Unemployment1, Unemployemnt2)->Unemployment
>>>>>>> d847ce27f09e928fbcaba91f8bfbfa15db68b4a6

#And just like that we have the data frame for unemployment for every state for a year.

#Time to do the eia api

eia_set_key("8a87a727635f5c834e2799cd76fcb820")
<<<<<<< HEAD
eia_data <- eai_id$id
eia_data
eia_series(eia_data)->df
=======
eia_avg_elec <- eai_avg_elect_id$id
eia_emmission<- eai_carbon_emission_id$id
eia_customers<- eai_customers_id
eia_series(eia_avg_elec)->avg_elec
eia_emmission
eia_series("EMISS.CO2-TOTV-EC-TO-AL.A")
eia_series(eia_emmission)->emmissions_carbon
avg_elec
emmissions_carbon

<<<<<<< HEAD
=======
df
>>>>>>> d847ce27f09e928fbcaba91f8bfbfa15db68b4a6
>>>>>>> origin/main

unnest(avg_elec, data)->Retail_cost_electricity
Retail_cost_electricity

<<<<<<< HEAD
=======

>>>>>>> d847ce27f09e928fbcaba91f8bfbfa15db68b4a6
#And now we hat the retail electric cost data frame.
#We can further clean the data from here and pull it into a shiny app.
#We can also quickly build a data frame with a large query letting us acess a lot of data.
#We can also engineer custom queries if we have the time.
#Let me know if you have questions.
```
```{r}
#Graph friendly data frame

Retail_cost_electricity %>% 
  select(geography, date, value)->eai_data
eai_data 

#So we can add the months to the eai data
month_num<-tibble(month_name = month.name, month = c(1:12))
#allows us to join the data frames by month
month_num %>% 
  mutate(month = case_when(
    month<10 ~ str_c("0",as.character(month)),
    month>=10 ~ str_c(as.character(month))
  ))->month_num
#Get's us year and month which we will need.
eai_data %>% 
  separate(geography, c("country", "abb"),"-") %>% 
  separate(date, c("year", "month", "day"), "-") %>% 
  select(-day)->eai_data
#lets us add states name to data frame
states %>% 
  rename(abb = state_abrv)->states

#adds month name and state names
left_join(eai_data, month_num, by = "month")->eai_data
left_join(eai_data, states, by = "abb")->eai_data

eai_data
#Makes things look nice.
eai_data %>% 
  select(-c(country, month, state_code)) %>% 
  relocate(c(state_name, abb, month_name, year, value)) %>% 
  rename(month = month_name)->eai_data

#Making a better BLS
#Changed name to do join
states %>% 
  rename(state = state_code)->states
Unemployment->BLS_data

#adding state name and type
left_join(BLS_data, BLS_id, by = "seriesID")->BLS_data
left_join(BLS_data, states, by = "state")->BLS_data

#cleaning the data frame
BLS_data %>% 
  select(-c(period, start, end, seriesID, state)) %>% 
  rename(month = periodName) %>% 
  relocate(c(state_name, abb, month))->BLS_data

<<<<<<< HEAD
BLS_data
eai_data %>% 
  filter(year>=2019)
```
=======
#The BLS data frame is more up to date. We will need to remove march of this year.
BLS_data %>% 
  filter(!(month == "March" & year == "2021"))->BLS_data
#The eai data frame goes back farther than the BLS so we need to remove the excess.
eai_data %>% 
  filter(year>=2019)->eai_data

#So we have two columns with the values from each data frame.
eai_data %>% 
  rename(avg_electricity = value)->eai_data
BLS_data %>% 
  rename(unemployment_rate = value)->BLS_data

#creating the full data set
full_join(BLS_data, eai_data)->Full_data
Full_data %>% 
  select(-type)->Full_data
Full_data
```

>>>>>>> d847ce27f09e928fbcaba91f8bfbfa15db68b4a6
